<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention Task Experiment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%);
            color: #2C1810;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Falling leaves animation */
        .leaf {
            position: fixed;
            width: 30px;
            height: 30px;
            opacity: 0.7;
            animation: fall linear infinite;
            pointer-events: none;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .container {
            background: rgba(255, 248, 240, 0.95);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            text-align: center;
            border: 3px solid #8B4513;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1 {
            color: #8B4513;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #A0522D;
            margin-bottom: 20px;
        }

        input, button {
            margin: 10px;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid #8B4513;
        }

        input {
            width: 300px;
            background: white;
        }

        button {
            background: #D2691E;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #A0522D;
            transform: scale(1.05);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .instructions {
            text-align: left;
            line-height: 1.8;
            margin: 20px 0;
        }

        .instructions ul {
            margin-left: 30px;
        }

        #experimentArea {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #fixation {
            font-size: 60px;
            font-weight: bold;
            color: #8B4513;
        }

        #letterDisplay {
            font-size: 80px;
            font-weight: bold;
            color: #2C1810;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', 'Helvetica', sans-serif;
        }

        #emotionalWord {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
            color: #DC143C;
            opacity: 0;
            transition: opacity 0.05s;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 8px;
        }

        .progress {
            margin: 20px 0;
            font-size: 18px;
            color: #A0522D;
            font-weight: bold;
        }

        .break-screen {
            padding: 40px;
        }

        .break-screen h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #8B4513;
        }

        .november-decoration {
            font-size: 50px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Falling leaves -->
    <div id="leaves"></div>

    <div class="container">
        <!-- Title Page -->
        <div id="titlePage" class="page active">
            <div class="november-decoration">üçÇ üçÅ ü¶É üçÇ üçÅ</div>
            <h1>Attention & Perception Study</h1>
            <p style="font-size: 1.2em; margin: 30px 0;">Welcome to our research experiment</p>
            <p style="margin: 20px 0;">This study investigates visual attention and letter detection</p>
            <button onclick="goToPage('participantPage')">Begin</button>
            <div class="november-decoration">üçÇ üçÅ üåæ üçÇ üçÅ</div>
        </div>

        <!-- Participant Details Page -->
        <div id="participantPage" class="page">
            <h1>Participant Information</h1>
            <div class="form-group">
                <label>Participant ID:</label>
                <input type="text" id="participantId" placeholder="Enter your ID">
            </div>
            <div class="form-group">
                <label>Age:</label>
                <input type="number" id="participantAge" placeholder="Enter your age" min="18" max="100">
            </div>
            <div class="form-group">
                <label>Gender:</label>
                <select id="participantGender" style="width: 300px; padding: 12px;">
                    <option value="">Select...</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
            </div>
            <button onclick="saveParticipantData()">Continue</button>
        </div>

        <!-- Instructions Page -->
        <div id="instructionsPage" class="page">
            <h1>Instructions</h1>
            <div class="instructions">
                <p><strong>Task Overview:</strong></p>
                <ul>
                    <li>You will see a rapid stream of letters appearing one at a time</li>
                    <li>Your task is to press the <strong>SPACEBAR</strong> as quickly as possible when you see the letter <strong>X</strong></li>
                    <li>Each trial begins with a fixation cross (+) in the center</li>
                    <li>15 letters will appear rapidly, one after another</li>
                    <li>Some trials will contain the letter X, others will not</li>
                    <li>Words may briefly appear during the letter stream - ignore them and focus on detecting X</li>
                </ul>
                <br>
                <p><strong>Important:</strong></p>
                <ul>
                    <li>Respond as quickly and accurately as possible</li>
                    <li>Only press the spacebar when you see X</li>
                    <li>Keep your eyes on the center of the screen</li>
                    <li>You will complete 10 practice trials first</li>
                    <li>The experiment has 3 blocks with breaks in between</li>
                </ul>
            </div>
            <button onclick="startPractice()">Start Practice Trials</button>
        </div>

        <!-- Experiment Area -->
        <div id="experimentPage" class="page">
            <div class="progress" id="progressText"></div>
            <div id="experimentArea">
                <div id="fixation"></div>
                <div id="letterDisplay"></div>
                <div id="emotionalWord"></div>
            </div>
        </div>

        <!-- Break Page -->
        <div id="breakPage" class="page">
            <div class="break-screen">
                <div class="november-decoration">üçÇ ‚òï üçÇ</div>
                <h2>Take a Break</h2>
                <p id="breakText" style="font-size: 1.2em; margin: 20px 0;"></p>
                <p style="margin: 20px 0;">Rest your eyes and relax for a moment.</p>
                <button onclick="continueAfterBreak()">Continue</button>
            </div>
        </div>

        <!-- Thank You Page -->
        <div id="thankYouPage" class="page">
            <div class="november-decoration">üçÇ üçÅ ü¶É üçÇ üçÅ</div>
            <h1>Thank You!</h1>
            <p style="font-size: 1.2em; margin: 30px 0;">You have completed the experiment.</p>
            <p style="margin: 20px 0;">Your data has been prepared for download.</p>
            <button id="downloadBtn" onclick="downloadData()">Download Results (CSV)</button>
            <div class="november-decoration">üçÇ üçÅ üåæ üçÇ üçÅ</div>
        </div>
    </div>

    <script>
        // Experimental stimuli
        const stimuli = {
            positiveHigh: ['DELIGHTED', 'ECSTATIC', 'THRILLED', 'JOYFUL', 'ELATED', 'WONDERFUL'],
            positiveLow: ['PLEASANT', 'NICE', 'DECENT', 'FINE', 'OKAY', 'GOOD'],
            negativeHigh: ['TERRIBLE', 'HORRIBLE', 'DREADFUL', 'AWFUL', 'TRAGIC', 'DEVASTATING'],
            negativeLow: ['UNPLEASANT', 'BAD', 'POOR', 'NEGATIVE', 'UNFAVORABLE', 'MEDIOCRE'],
            neutral: ['TYPICAL', 'AVERAGE', 'ORDINARY', 'REGULAR', 'NORMAL', 'STANDARD']
        };

        const allLetters = 'ABCDEFGHIJKLMNOPQRSTUVWYZ'.split(''); // Excluding X
        
        let participantData = {};
        let trials = [];
        let currentTrial = 0;
        let currentBlock = 0;
        let isPractice = true;
        let responses = [];
        let trialStartTime = 0;
        let targetPresent = false;
        let responded = false;

        // Initialize falling leaves
        function createLeaves() {
            const leaves = ['üçÇ', 'üçÅ'];
            const container = document.getElementById('leaves');
            for (let i = 0; i < 15; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.textContent = leaves[Math.floor(Math.random() * leaves.length)];
                leaf.style.left = Math.random() * 100 + '%';
                leaf.style.animationDuration = (Math.random() * 10 + 10) + 's';
                leaf.style.animationDelay = Math.random() * 5 + 's';
                leaf.style.fontSize = (Math.random() * 20 + 20) + 'px';
                container.appendChild(leaf);
            }
        }

        createLeaves();

        // Navigation functions
        function goToPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function saveParticipantData() {
            const id = document.getElementById('participantId').value.trim();
            const age = document.getElementById('participantAge').value;
            const gender = document.getElementById('participantGender').value;

            if (!id || !age || !gender) {
                alert('Please fill in all fields');
                return;
            }

            participantData = {
                id: id,
                age: age,
                gender: gender,
                date: new Date().toISOString()
            };

            goToPage('instructionsPage');
        }

        // Generate trials
        function generateTrials(isPracticeTrials = false) {
            const generatedTrials = [];
            const numTrialsPerCondition = isPracticeTrials ? 2 : 24;
            const conditions = Object.keys(stimuli);

            conditions.forEach(condition => {
                for (let i = 0; i < numTrialsPerCondition; i++) {
                    const hasTarget = Math.random() < 0.7; // 70% have X
                    const emotionalWordPosition = Math.floor(Math.random() * 12); // 0-11 so target can be after
                    const targetPosition = hasTarget ? (emotionalWordPosition + 1 + Math.floor(Math.random() * (14 - emotionalWordPosition))) : -1; // Target always after emotional word
                    const emotionalWord = stimuli[condition][Math.floor(Math.random() * stimuli[condition].length)];

                    generatedTrials.push({
                        condition: condition,
                        hasTarget: hasTarget,
                        targetPosition: targetPosition,
                        emotionalWord: emotionalWord,
                        emotionalWordPosition: emotionalWordPosition,
                        isPractice: isPracticeTrials
                    });
                }
            });

            // Shuffle trials
            return generatedTrials.sort(() => Math.random() - 0.5);
        }

        function startPractice() {
            isPractice = true;
            trials = generateTrials(true);
            currentTrial = 0;
            goToPage('experimentPage');
            updateProgress();
            setTimeout(runTrial, 1000);
        }

        function startMainExperiment() {
            isPractice = false;
            trials = generateTrials(false);
            currentTrial = 0;
            currentBlock = 1;
            goToPage('experimentPage');
            updateProgress();
            setTimeout(runTrial, 1000);
        }

        function updateProgress() {
            const progressText = document.getElementById('progressText');
            if (isPractice) {
                progressText.textContent = `Practice Trial ${currentTrial + 1} / ${trials.length}`;
            } else {
                const blockTrial = (currentTrial % 40) + 1;
                progressText.textContent = `Block ${currentBlock} / 3 - Trial ${blockTrial} / 40`;
            }
        }

        function runTrial() {
            if (currentTrial >= trials.length) {
                if (isPractice) {
                    alert('Practice complete! The main experiment will now begin.');
                    startMainExperiment();
                } else if (currentTrial < 120) {
                    // Check if we need a break
                    if (currentTrial === 40 || currentTrial === 80) {
                        currentBlock++;
                        showBreak();
                    } else {
                        continueNextTrial();
                    }
                } else {
                    finishExperiment();
                }
                return;
            }

            const trial = trials[currentTrial];
            responded = false;
            targetPresent = trial.hasTarget;

            // Show fixation
            showFixation();

            // After fixation, show letter stream
            setTimeout(() => {
                showLetterStream(trial);
            }, 300);
        }

        function showFixation() {
            document.getElementById('fixation').textContent = '+';
            document.getElementById('letterDisplay').textContent = '';
            document.getElementById('emotionalWord').style.opacity = '0';
        }

        function showLetterStream(trial) {
            document.getElementById('fixation').textContent = '';
            trialStartTime = performance.now();
            let letterIndex = 0;

            function showNextLetter() {
                if (letterIndex >= 15) {
                    document.getElementById('letterDisplay').textContent = '';
                    document.getElementById('emotionalWord').style.opacity = '0';
                    
                    // Record response if no key was pressed
                    if (!responded) {
                        recordResponse(trial, false, null);
                    }
                    
                    // Inter-trial interval (800-1200ms)
                    const iti = 800 + Math.random() * 400;
                    setTimeout(() => {
                        currentTrial++;
                        if (!isPractice && (currentTrial === 40 || currentTrial === 80)) {
                            currentBlock++;
                            showBreak();
                        } else {
                            updateProgress();
                            runTrial();
                        }
                    }, iti);
                    return;
                }

                // Check if it's time to show emotional word
                if (letterIndex === trial.emotionalWordPosition) {
                    // Hide letter, show only emotional word
                    document.getElementById('letterDisplay').textContent = '';
                    const emotionalWordEl = document.getElementById('emotionalWord');
                    emotionalWordEl.textContent = trial.emotionalWord;
                    emotionalWordEl.style.opacity = '1';
                    
                    const stimDuration = 180 + Math.random() * 20; // 180-200ms
                    setTimeout(() => {
                        emotionalWordEl.style.opacity = '0';
                        letterIndex++;
                        // Continue with next letter after word disappears
                        setTimeout(showNextLetter, 150);
                    }, stimDuration);
                } else {
                    // Show letter normally
                    let letter;
                    if (letterIndex === trial.targetPosition) {
                        letter = 'X';
                    } else {
                        letter = allLetters[Math.floor(Math.random() * allLetters.length)];
                    }
                    document.getElementById('letterDisplay').textContent = letter;

                    letterIndex++;
                    // Fixed letter duration of 150ms
                    setTimeout(showNextLetter, 150);
                }
            }

            showNextLetter();
        }

        function recordResponse(trial, keyPressed, reactionTime) {
            if (responded) return; // Prevent duplicate responses
            responded = true;

            const hit = trial.hasTarget && keyPressed;
            const miss = trial.hasTarget && !keyPressed;
            const falseAlarm = !trial.hasTarget && keyPressed;
            const correctRejection = !trial.hasTarget && !keyPressed;

            responses.push({
                participantId: participantData.id,
                trialNumber: currentTrial + 1,
                block: currentBlock,
                isPractice: trial.isPractice,
                condition: trial.condition,
                emotionalWord: trial.emotionalWord,
                targetPresent: trial.hasTarget,
                targetPosition: trial.targetPosition,
                emotionalWordPosition: trial.emotionalWordPosition,
                responseGiven: keyPressed,
                reactionTime: reactionTime,
                hit: hit,
                miss: miss,
                falseAlarm: falseAlarm,
                correctRejection: correctRejection,
                timestamp: new Date().toISOString()
            });
        }

        function showBreak() {
            const breakText = document.getElementById('breakText');
            breakText.textContent = `You have completed Block ${currentBlock - 1} of 3.`;
            goToPage('breakPage');
        }

        function continueAfterBreak() {
            goToPage('experimentPage');
            updateProgress();
            setTimeout(runTrial, 1000);
        }

        function continueNextTrial() {
            updateProgress();
            runTrial();
        }

        function finishExperiment() {
            goToPage('thankYouPage');
        }

        function downloadData() {
            // Create CSV
            let csv = 'ParticipantID,Age,Gender,TrialNumber,Block,IsPractice,Condition,EmotionalWord,TargetPresent,TargetPosition,EmotionalWordPosition,ResponseGiven,ReactionTime,Hit,Miss,FalseAlarm,CorrectRejection,Timestamp\n';
            
            responses.forEach(r => {
                csv += `${r.participantId},${participantData.age},${participantData.gender},${r.trialNumber},${r.block},${r.isPractice},${r.condition},${r.emotionalWord},${r.targetPresent},${r.targetPosition},${r.emotionalWordPosition},${r.responseGiven},${r.reactionTime || 'NA'},${r.hit},${r.miss},${r.falseAlarm},${r.correctRejection},${r.timestamp}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attention_task_${participantData.id}_${Date.now()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Keyboard event listener
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && document.getElementById('experimentPage').classList.contains('active')) {
                e.preventDefault();
                if (!responded && trialStartTime > 0) {
                    const rt = performance.now() - trialStartTime;
                    recordResponse(trials[currentTrial], true, rt);
                }
            }
        });
    </script>
</body>
</html>
